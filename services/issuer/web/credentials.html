<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>VVP Issuer - Credential Management</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 2rem;
        max-width: 1100px;
        background: #f8f9fa;
      }
      h1 { color: #2c3e50; margin-bottom: 0.5rem; }
      .subtitle { color: #666; margin-bottom: 2rem; }
      .nav-links {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }
      .nav-links a {
        color: #3498db;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        background: white;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .nav-links a:hover { background: #e8f4ff; }
      .nav-links a.active {
        background: #3498db;
        color: white;
      }
      .card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .card h2 { margin-top: 0; color: #34495e; }
      label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
      input[type="text"], select, textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      textarea {
        font-family: monospace;
        min-height: 150px;
        resize: vertical;
      }
      input[type="text"]:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
      }
      .form-group { margin-bottom: 1rem; }
      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 1rem 0;
      }
      .checkbox-row input { width: auto; }
      .checkbox-row label { margin: 0; font-weight: normal; }
      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover { background: #2980b9; }
      button:disabled { background: #bdc3c7; cursor: not-allowed; }
      button.danger {
        background: #e74c3c;
      }
      button.danger:hover {
        background: #c0392b;
      }
      button.small {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
      }
      .result-field {
        margin: 0.75rem 0;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
      }
      .result-field strong { color: #495057; }
      .result-field code {
        display: block;
        margin-top: 0.25rem;
        word-break: break-all;
        font-family: monospace;
        font-size: 0.9rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th, td {
        text-align: left;
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
      }
      th { background: #f8f9fa; font-weight: 600; }
      tr:hover { background: #f8f9fa; }
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
      }
      .status-issued {
        background: #d4edda;
        color: #155724;
      }
      .status-revoked {
        background: #f8d7da;
        color: #721c24;
      }
      .said-cell {
        font-family: monospace;
        font-size: 0.85rem;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
      .hint {
        font-size: 0.875rem;
        color: #666;
        margin-top: 0.25rem;
      }
    </style>
  </head>
  <body>
    <h1>VVP Issuer</h1>
    <p class="subtitle">Credential Management</p>

    <nav class="nav-links">
      <a href="/create">Create Identity</a>
      <a href="/registry/ui">Manage Registries</a>
      <a href="/schemas/ui">Browse Schemas</a>
      <a href="/credentials/ui" class="active">Issue Credentials</a>
    </nav>

    <!-- Issue Credential Form -->
    <div class="card">
      <h2>Issue Credential</h2>
      <form id="issueForm">
        <div class="form-group">
          <label for="registry">Registry</label>
          <select id="registry" required>
            <option value="">Loading registries...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="schema">Schema</label>
          <select id="schema" required>
            <option value="">Loading schemas...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="attributes">Attributes (JSON)</label>
          <textarea id="attributes" placeholder='{"numbers": {"tn": ["+12025551234"]}, "channel": "voice", "doNotOriginate": false}' required></textarea>
          <p class="hint">Enter the credential attributes as valid JSON. The structure depends on the selected schema.</p>
        </div>

        <div class="form-group">
          <label for="recipient">Recipient AID (optional)</label>
          <input type="text" id="recipient" placeholder="Leave empty for untargeted credential"/>
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="private"/>
          <label for="private">Add privacy-preserving nonces</label>
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="publishWitnesses" checked/>
          <label for="publishWitnesses">Publish to witnesses</label>
        </div>

        <button type="submit" id="issueBtn">Issue Credential</button>
      </form>

      <div id="issueResult"></div>
    </div>

    <!-- Credentials List -->
    <div class="card">
      <h2>Issued Credentials</h2>
      <div id="credentialsList">
        <p class="loading">Loading credentials...</p>
      </div>
    </div>

    <script>
      const registrySelect = document.getElementById('registry');
      const schemaSelect = document.getElementById('schema');
      const attributesInput = document.getElementById('attributes');
      const recipientInput = document.getElementById('recipient');
      const privateCheck = document.getElementById('private');
      const publishCheck = document.getElementById('publishWitnesses');
      const issueForm = document.getElementById('issueForm');
      const issueBtn = document.getElementById('issueBtn');
      const issueResult = document.getElementById('issueResult');
      const credentialsList = document.getElementById('credentialsList');

      // Load registries
      async function loadRegistries() {
        try {
          const res = await fetch('/registry');
          if (!res.ok) throw new Error('Failed to load registries');
          const data = await res.json();

          registrySelect.innerHTML = '<option value="">Select a registry...</option>';
          for (const reg of data.registries) {
            const option = document.createElement('option');
            option.value = reg.name;
            option.textContent = `${reg.name} (${reg.registry_key.substring(0, 12)}...)`;
            registrySelect.appendChild(option);
          }
        } catch (e) {
          registrySelect.innerHTML = '<option value="">Error loading registries</option>';
          console.error(e);
        }
      }

      // Load schemas
      async function loadSchemas() {
        try {
          const res = await fetch('/schema');
          if (!res.ok) throw new Error('Failed to load schemas');
          const data = await res.json();

          schemaSelect.innerHTML = '<option value="">Select a schema...</option>';
          for (const schema of data.schemas) {
            const option = document.createElement('option');
            option.value = schema.said;
            option.textContent = schema.title;
            schemaSelect.appendChild(option);
          }
        } catch (e) {
          schemaSelect.innerHTML = '<option value="">Error loading schemas</option>';
          console.error(e);
        }
      }

      // Load credentials
      async function loadCredentials() {
        try {
          const res = await fetch('/credential');
          if (!res.ok) throw new Error('Failed to load credentials');
          const data = await res.json();

          if (data.credentials.length === 0) {
            credentialsList.innerHTML = '<p>No credentials issued yet.</p>';
            return;
          }

          let html = `
            <table>
              <thead>
                <tr>
                  <th>SAID</th>
                  <th>Schema</th>
                  <th>Status</th>
                  <th>Issued</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;

          for (const cred of data.credentials) {
            const statusClass = cred.status === 'issued' ? 'status-issued' : 'status-revoked';
            const issuedDate = cred.issuance_dt ? new Date(cred.issuance_dt).toLocaleDateString() : 'N/A';

            html += `
              <tr>
                <td class="said-cell" title="${cred.said}">${cred.said.substring(0, 16)}...</td>
                <td class="said-cell" title="${cred.schema_said}">${cred.schema_said.substring(0, 12)}...</td>
                <td><span class="status-badge ${statusClass}">${cred.status}</span></td>
                <td>${issuedDate}</td>
                <td>
                  ${cred.status === 'issued' ? `<button class="small danger" onclick="revokeCredential('${cred.said}')">Revoke</button>` : ''}
                </td>
              </tr>
            `;
          }

          html += '</tbody></table>';
          credentialsList.innerHTML = html;
        } catch (e) {
          credentialsList.innerHTML = '<p class="error">Error loading credentials</p>';
          console.error(e);
        }
      }

      // Issue credential
      issueForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        issueBtn.disabled = true;
        issueBtn.textContent = 'Issuing...';
        issueResult.innerHTML = '';

        try {
          // Parse and validate JSON
          let attributes;
          try {
            attributes = JSON.parse(attributesInput.value);
          } catch (err) {
            throw new Error('Invalid JSON in attributes: ' + err.message);
          }

          const payload = {
            registry_name: registrySelect.value,
            schema_said: schemaSelect.value,
            attributes: attributes,
            private: privateCheck.checked,
            publish_to_witnesses: publishCheck.checked,
          };

          if (recipientInput.value.trim()) {
            payload.recipient_aid = recipientInput.value.trim();
          }

          const res = await fetch('/credential/issue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.detail || 'Failed to issue credential');
          }

          issueResult.innerHTML = `
            <div class="success">
              <strong>Credential Issued Successfully!</strong>
              <div class="result-field">
                <strong>Credential SAID:</strong>
                <code>${data.credential.said}</code>
              </div>
              <div class="result-field">
                <strong>Status:</strong>
                <code>${data.credential.status}</code>
              </div>
              <div class="result-field">
                <strong>Issued At:</strong>
                <code>${data.credential.issuance_dt}</code>
              </div>
            </div>
          `;

          // Refresh the list
          loadCredentials();

          // Clear form
          attributesInput.value = '';
          recipientInput.value = '';
          privateCheck.checked = false;

        } catch (err) {
          issueResult.innerHTML = `<div class="error"><strong>Error:</strong> ${err.message}</div>`;
        } finally {
          issueBtn.disabled = false;
          issueBtn.textContent = 'Issue Credential';
        }
      });

      // Revoke credential
      async function revokeCredential(said) {
        if (!confirm(`Are you sure you want to revoke credential ${said.substring(0, 16)}...?`)) {
          return;
        }

        try {
          const res = await fetch(`/credential/${said}/revoke`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ publish_to_witnesses: true }),
          });

          if (!res.ok) {
            const data = await res.json();
            throw new Error(data.detail || 'Failed to revoke credential');
          }

          alert('Credential revoked successfully');
          loadCredentials();
        } catch (err) {
          alert('Error: ' + err.message);
        }
      }

      // Initialize
      loadRegistries();
      loadSchemas();
      loadCredentials();
    </script>
  </body>
</html>
