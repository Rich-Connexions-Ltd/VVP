<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vetter Certification - VVP Issuer</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <style>
    /* Searchable Multi-Select component */
    .searchable-select {
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }
    .searchable-select-header {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    .searchable-select-header input {
      flex: 1;
      padding: 0.4rem 0.6rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .searchable-select-header button {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      background: #6c757d;
    }
    .searchable-select-header button:hover { background: #5a6268; }
    .searchable-select-count {
      font-size: 0.85rem;
      color: #666;
      white-space: nowrap;
    }
    .searchable-select-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      padding: 0.5rem;
      min-height: 1.5rem;
    }
    .searchable-select-chips:empty::after {
      content: 'None selected';
      color: #999;
      font-size: 0.85rem;
      font-style: italic;
    }
    .select-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.4rem;
      background: #e9ecef;
      border-radius: 3px;
      font-size: 0.8rem;
    }
    .select-chip.ecc { background: #d1ecf1; color: #0c5460; }
    .select-chip.jurisdiction { background: #d4edda; color: #155724; }
    .select-chip button {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font-size: 0.9rem;
      cursor: pointer;
      color: inherit;
      line-height: 1;
    }
    .searchable-select-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .searchable-select-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.3rem 0.25rem;
      cursor: pointer;
      border-radius: 3px;
      font-size: 0.9rem;
    }
    .searchable-select-item:hover { background: #e8f4ff; }
    .searchable-select-item input { margin: 0; }
    .searchable-select-item.hidden { display: none; }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 1rem;
      border-radius: 0 4px 4px 0;
      margin: 1rem 0;
    }
    .warning-box {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      padding: 1rem;
      border-radius: 0 4px 4px 0;
      margin: 1rem 0;
    }
    .cert-list {
      margin-top: 1rem;
    }
    .cert-item {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 0.5rem;
    }
    .cert-item h4 {
      margin: 0 0 0.5rem 0;
      color: var(--vvp-primary);
    }
    .cert-meta {
      display: flex;
      gap: 1.5rem;
      font-size: 0.9rem;
      color: #666;
    }
    .cert-targets {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .target-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      background: #e9ecef;
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: monospace;
    }
    .target-badge.ecc { background: #d1ecf1; color: #0c5460; }
    .target-badge.jurisdiction { background: #d4edda; color: #155724; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-brand">
      <img src="/static/ovc-logo.png" alt="OVC" class="ovc-logo">
      <a href="/ui/" class="logo">
        <span class="service-label">VVP</span>
        Issuer
      </a>
    </div>
    <nav class="nav-links">
      <a href="/ui/identity">Identities</a>
      <a href="/ui/schemas">Schemas</a>
      <a href="/ui/credentials">Credentials</a>
      <a href="/ui/dossier">Dossiers</a>
      <a href="/ui/vvp">VVP Headers</a>
      <a href="/ui/tn-mappings">TN Mappings</a>
      <a href="/ui/pbx">PBX</a>
      <a href="/ui/help">Help</a>
      <a href="/ui/admin">Admin</a>
      <a href="/organizations/ui" style="display:none">Organizations</a>
      <a href="https://vvp-verifier.rcnx.io" class="verifier-link" target="_blank">Verifier &#8599;</a>
    </nav>
  </header>

  <main>
    <h1>Vetter Certification</h1>
    <p class="subtitle">Issue credentials that authorize vetters for specific geographic regions</p>

    <div class="info-box">
      <strong>About Vetter Certification</strong>
      <p>A Vetter Certification credential authorizes an organization to issue VVP credentials for specific geographic regions. It defines:</p>
      <ul>
        <li><strong>ECC Targets</strong>: E.164 country codes for telephone number attestation</li>
        <li><strong>Jurisdiction Targets</strong>: ISO 3166-1 alpha-3 codes for incorporation and brand credentials</li>
      </ul>
    </div>

    <!-- Issue Vetter Certification Form -->
    <div class="card">
      <h2>Issue Vetter Certification</h2>

      <div class="warning-box">
        <strong>Note:</strong> In production, Vetter Certifications are typically issued by a governance authority (e.g., GSMA).
        This form is for testing and development purposes.
      </div>

      <form id="issueForm">
        <div class="form-group">
          <label for="vetterOrg">Vetter Organization (recipient)</label>
          <select id="vetterOrg" required>
            <option value="">Loading organizations...</option>
          </select>
          <p class="hint">Select the organization to be authorized as a vetter</p>
        </div>

        <!-- ECC Targets -->
        <div class="form-group">
          <label>ECC Targets (E.164 Country Codes)</label>
          <p class="hint">Select the country codes for which this vetter can authorize telephone numbers</p>
          <div id="eccSearchableSelect"></div>
        </div>

        <!-- Jurisdiction Targets -->
        <div class="form-group">
          <label>Jurisdiction Targets (ISO 3166-1 Alpha-3)</label>
          <p class="hint">Select the countries for which this vetter can issue Legal Entity and Brand credentials</p>
          <div id="jurisdictionSearchableSelect"></div>
        </div>

        <div class="form-group">
          <label for="expiry">Certification Expiry (optional)</label>
          <input type="datetime-local" id="expiry"/>
        </div>

        <button type="submit" id="issueBtn">Issue Vetter Certification</button>
      </form>

      <div id="issueResult"></div>
    </div>

    <!-- Existing Vetter Certifications -->
    <div class="card">
      <h2>Existing Vetter Certifications</h2>
      <div id="certList">
        <p class="loading">Loading certifications...</p>
      </div>
    </div>
  </main>

  <script src="/static/shared.js"></script>
  <script>
    // E.164 country codes with names
    const E164_CODES = [
      { code: "1", name: "USA/Canada" },
      { code: "7", name: "Russia/Kazakhstan" },
      { code: "20", name: "Egypt" },
      { code: "27", name: "South Africa" },
      { code: "30", name: "Greece" },
      { code: "31", name: "Netherlands" },
      { code: "32", name: "Belgium" },
      { code: "33", name: "France" },
      { code: "34", name: "Spain" },
      { code: "36", name: "Hungary" },
      { code: "39", name: "Italy" },
      { code: "40", name: "Romania" },
      { code: "41", name: "Switzerland" },
      { code: "43", name: "Austria" },
      { code: "44", name: "United Kingdom" },
      { code: "45", name: "Denmark" },
      { code: "46", name: "Sweden" },
      { code: "47", name: "Norway" },
      { code: "48", name: "Poland" },
      { code: "49", name: "Germany" },
      { code: "51", name: "Peru" },
      { code: "52", name: "Mexico" },
      { code: "53", name: "Cuba" },
      { code: "54", name: "Argentina" },
      { code: "55", name: "Brazil" },
      { code: "56", name: "Chile" },
      { code: "57", name: "Colombia" },
      { code: "58", name: "Venezuela" },
      { code: "60", name: "Malaysia" },
      { code: "61", name: "Australia" },
      { code: "62", name: "Indonesia" },
      { code: "63", name: "Philippines" },
      { code: "64", name: "New Zealand" },
      { code: "65", name: "Singapore" },
      { code: "66", name: "Thailand" },
      { code: "81", name: "Japan" },
      { code: "82", name: "South Korea" },
      { code: "84", name: "Vietnam" },
      { code: "86", name: "China" },
      { code: "90", name: "Turkey" },
      { code: "91", name: "India" },
      { code: "92", name: "Pakistan" },
      { code: "93", name: "Afghanistan" },
      { code: "94", name: "Sri Lanka" },
      { code: "95", name: "Myanmar" },
      { code: "98", name: "Iran" },
      { code: "212", name: "Morocco" },
      { code: "213", name: "Algeria" },
      { code: "216", name: "Tunisia" },
      { code: "218", name: "Libya" },
      { code: "234", name: "Nigeria" },
      { code: "254", name: "Kenya" },
      { code: "351", name: "Portugal" },
      { code: "352", name: "Luxembourg" },
      { code: "353", name: "Ireland" },
      { code: "354", name: "Iceland" },
      { code: "358", name: "Finland" },
      { code: "370", name: "Lithuania" },
      { code: "371", name: "Latvia" },
      { code: "372", name: "Estonia" },
      { code: "380", name: "Ukraine" },
      { code: "420", name: "Czech Republic" },
      { code: "421", name: "Slovakia" },
      { code: "852", name: "Hong Kong" },
      { code: "853", name: "Macau" },
      { code: "886", name: "Taiwan" },
      { code: "971", name: "UAE" },
      { code: "972", name: "Israel" },
      { code: "974", name: "Qatar" },
      { code: "966", name: "Saudi Arabia" },
    ];

    // ISO 3166-1 alpha-3 codes with names
    const ISO_CODES = [
      { code: "AFG", name: "Afghanistan" },
      { code: "ALB", name: "Albania" },
      { code: "DZA", name: "Algeria" },
      { code: "ARG", name: "Argentina" },
      { code: "AUS", name: "Australia" },
      { code: "AUT", name: "Austria" },
      { code: "BEL", name: "Belgium" },
      { code: "BRA", name: "Brazil" },
      { code: "CAN", name: "Canada" },
      { code: "CHL", name: "Chile" },
      { code: "CHN", name: "China" },
      { code: "COL", name: "Colombia" },
      { code: "CUB", name: "Cuba" },
      { code: "CZE", name: "Czech Republic" },
      { code: "DEU", name: "Germany" },
      { code: "DNK", name: "Denmark" },
      { code: "EGY", name: "Egypt" },
      { code: "ESP", name: "Spain" },
      { code: "EST", name: "Estonia" },
      { code: "FIN", name: "Finland" },
      { code: "FRA", name: "France" },
      { code: "GBR", name: "United Kingdom" },
      { code: "GRC", name: "Greece" },
      { code: "HKG", name: "Hong Kong" },
      { code: "HUN", name: "Hungary" },
      { code: "IDN", name: "Indonesia" },
      { code: "IND", name: "India" },
      { code: "IRL", name: "Ireland" },
      { code: "IRN", name: "Iran" },
      { code: "ISL", name: "Iceland" },
      { code: "ISR", name: "Israel" },
      { code: "ITA", name: "Italy" },
      { code: "JPN", name: "Japan" },
      { code: "KAZ", name: "Kazakhstan" },
      { code: "KEN", name: "Kenya" },
      { code: "KOR", name: "South Korea" },
      { code: "LBY", name: "Libya" },
      { code: "LTU", name: "Lithuania" },
      { code: "LUX", name: "Luxembourg" },
      { code: "LVA", name: "Latvia" },
      { code: "MAC", name: "Macau" },
      { code: "MAR", name: "Morocco" },
      { code: "MEX", name: "Mexico" },
      { code: "MMR", name: "Myanmar" },
      { code: "MYS", name: "Malaysia" },
      { code: "NGA", name: "Nigeria" },
      { code: "NLD", name: "Netherlands" },
      { code: "NOR", name: "Norway" },
      { code: "NZL", name: "New Zealand" },
      { code: "PAK", name: "Pakistan" },
      { code: "PER", name: "Peru" },
      { code: "PHL", name: "Philippines" },
      { code: "POL", name: "Poland" },
      { code: "PRT", name: "Portugal" },
      { code: "QAT", name: "Qatar" },
      { code: "ROU", name: "Romania" },
      { code: "RUS", name: "Russia" },
      { code: "SAU", name: "Saudi Arabia" },
      { code: "SGP", name: "Singapore" },
      { code: "SVK", name: "Slovakia" },
      { code: "SWE", name: "Sweden" },
      { code: "CHE", name: "Switzerland" },
      { code: "THA", name: "Thailand" },
      { code: "TUN", name: "Tunisia" },
      { code: "TUR", name: "Turkey" },
      { code: "TWN", name: "Taiwan" },
      { code: "UKR", name: "Ukraine" },
      { code: "ARE", name: "UAE" },
      { code: "USA", name: "United States" },
      { code: "VEN", name: "Venezuela" },
      { code: "VNM", name: "Vietnam" },
      { code: "ZAF", name: "South Africa" },
    ];

    // Vetter Certification schema SAID
    const VETTER_SCHEMA_SAID = "EOefmhWU2qTpMiEQhXohE6z3xRXkpLloZdhTYIenlD4H";

    // Searchable Multi-Select component
    class SearchableMultiSelect {
      constructor(container, options, { type = '', commonCodes = [] } = {}) {
        this.selected = new Set();
        this.type = type;
        this.container = container;
        this.options = options;
        this.commonCodes = commonCodes;

        this.render();
      }

      render() {
        const prefix = this.type === 'ecc' ? '+' : '';

        // Sort: common first, then alphabetical
        const commonSet = new Set(this.commonCodes);
        const sorted = [
          ...this.options.filter(o => commonSet.has(o.code)),
          ...this.options.filter(o => !commonSet.has(o.code)),
        ];

        this.container.innerHTML = `
          <div class="searchable-select">
            <div class="searchable-select-header">
              <input type="text" placeholder="Search..." class="search-input">
              <button type="button" class="select-all-btn">All</button>
              <button type="button" class="clear-all-btn">Clear</button>
              <span class="searchable-select-count">0 selected</span>
            </div>
            <div class="searchable-select-chips"></div>
            <div class="searchable-select-list">
              ${sorted.map(o => `
                <label class="searchable-select-item" data-code="${o.code}" data-name="${o.name.toLowerCase()}">
                  <input type="checkbox" value="${o.code}">
                  ${prefix}${o.code} ${o.name}
                </label>
              `).join('')}
            </div>
          </div>
        `;

        // Search filtering
        const searchInput = this.container.querySelector('.search-input');
        searchInput.addEventListener('input', () => this.filter(searchInput.value));

        // Checkbox changes
        this.container.querySelectorAll('.searchable-select-item input').forEach(cb => {
          cb.addEventListener('change', () => {
            if (cb.checked) this.selected.add(cb.value);
            else this.selected.delete(cb.value);
            this.updateChips();
            this.updateCount();
          });
        });

        // Select All / Clear
        this.container.querySelector('.select-all-btn').addEventListener('click', () => {
          this.container.querySelectorAll('.searchable-select-item:not(.hidden) input').forEach(cb => {
            cb.checked = true;
            this.selected.add(cb.value);
          });
          this.updateChips();
          this.updateCount();
        });

        this.container.querySelector('.clear-all-btn').addEventListener('click', () => {
          this.container.querySelectorAll('.searchable-select-item input').forEach(cb => cb.checked = false);
          this.selected.clear();
          this.updateChips();
          this.updateCount();
        });
      }

      filter(query) {
        const q = query.toLowerCase();
        this.container.querySelectorAll('.searchable-select-item').forEach(item => {
          const code = item.dataset.code.toLowerCase();
          const name = item.dataset.name;
          item.classList.toggle('hidden', q && !code.includes(q) && !name.includes(q));
        });
      }

      updateChips() {
        const chipsContainer = this.container.querySelector('.searchable-select-chips');
        const prefix = this.type === 'ecc' ? '+' : '';
        const chipClass = this.type === 'ecc' ? 'ecc' : 'jurisdiction';
        chipsContainer.innerHTML = [...this.selected].map(code => {
          const opt = this.options.find(o => o.code === code);
          return `<span class="select-chip ${chipClass}">${prefix}${code}${opt ? ' ' + opt.name : ''}<button type="button" data-remove="${code}">&times;</button></span>`;
        }).join('');

        // Bind remove handlers
        chipsContainer.querySelectorAll('[data-remove]').forEach(btn => {
          btn.addEventListener('click', () => {
            const code = btn.dataset.remove;
            this.selected.delete(code);
            const cb = this.container.querySelector(`.searchable-select-item[data-code="${code}"] input`);
            if (cb) cb.checked = false;
            this.updateChips();
            this.updateCount();
          });
        });
      }

      updateCount() {
        const countEl = this.container.querySelector('.searchable-select-count');
        countEl.textContent = `${this.selected.size} selected`;
      }

      getSelected() {
        return [...this.selected];
      }
    }

    // Common country codes shown first
    const COMMON_ECC = ['1', '44', '49', '33', '61', '64'];
    const COMMON_JURISDICTION = ['USA', 'GBR', 'DEU', 'FRA', 'AUS', 'CAN'];

    // Load organizations for the recipient picker
    async function loadOrganizations() {
      const select = document.getElementById('vetterOrg');
      try {
        const res = await authFetch('/organizations/names?purpose=vetter');
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();

        select.innerHTML = '<option value="">Select an organization...</option>';
        for (const org of (data.organizations || [])) {
          if (!org.aid) continue; // skip orgs without an AID
          const option = document.createElement('option');
          option.value = org.id;
          option.textContent = org.name || org.aid;
          option.dataset.orgName = org.name || '';
          select.appendChild(option);
        }
      } catch (e) {
        select.innerHTML = '<option value="">Unable to load organizations</option>';
        console.warn('Failed to load organizations:', e);
      }
    }

    // (Vetter name auto-derived from org selection at submit time)

    // Load existing certifications
    async function loadCertifications() {
      const container = document.getElementById('certList');
      try {
        const res = await authFetch('/vetter-certifications');
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();

        const certs = data.certifications || [];

        if (certs.length === 0) {
          container.innerHTML = '<p class="hint">No vetter certifications issued yet.</p>';
          return;
        }

        let html = '';
        for (const cert of certs) {
          html += `
            <div class="cert-item">
              <h4>${cert.name || 'Vetter Certification'}</h4>
              <div class="cert-meta">
                <span><strong>SAID:</strong> ${cert.said.substring(0, 16)}...</span>
                <span><strong>Org:</strong> ${cert.organization_name || cert.organization_id.substring(0, 8) + '...'}</span>
                <span><strong>Status:</strong> ${cert.status}</span>
                <span><strong>Issued:</strong> ${new Date(cert.created_at).toLocaleDateString()}</span>
              </div>
              <div class="cert-targets">
                ${(cert.ecc_targets || []).map(t => `<span class="target-badge ecc">+${t}</span>`).join('')}
                ${(cert.jurisdiction_targets || []).map(t => `<span class="target-badge jurisdiction">${t}</span>`).join('')}
              </div>
            </div>
          `;
        }

        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = '<p class="hint">Unable to load certifications.</p>';
        console.error(e);
      }
    }

    // Issue form submission
    document.getElementById('issueForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('issueBtn');
      const result = document.getElementById('issueResult');

      btn.disabled = true;
      btn.textContent = 'Issuing...';
      result.innerHTML = '';

      try {
        const eccTargets = eccSelect.getSelected();
        const jurisdictionTargets = jurisdictionSelect.getSelected();

        if (eccTargets.length === 0) {
          throw new Error('Please select at least one ECC target country code');
        }
        if (jurisdictionTargets.length === 0) {
          throw new Error('Please select at least one jurisdiction target');
        }

        const attributes = {
          ecc_targets: eccTargets,
          jurisdiction_targets: jurisdictionTargets,
        };

        // Auto-derive vetter name from selected org
        const orgSelect = document.getElementById('vetterOrg');
        const selectedOpt = orgSelect.options[orgSelect.selectedIndex];
        const vetterName = (selectedOpt && selectedOpt.dataset.orgName) ? selectedOpt.dataset.orgName : '';
        if (!vetterName) {
          throw new Error('Please select an organization');
        }
        attributes.name = vetterName;

        const expiry = document.getElementById('expiry').value;
        if (expiry) {
          attributes.certificationExpiry = new Date(expiry).toISOString();
        }

        const orgId = document.getElementById('vetterOrg').value;
        if (!orgId) {
          throw new Error('Please select an organization');
        }

        const payload = {
          organization_id: orgId,
          ecc_targets: attributes.ecc_targets,
          jurisdiction_targets: attributes.jurisdiction_targets,
          name: attributes.name,
        };

        if (attributes.certificationExpiry) {
          payload.certificationExpiry = attributes.certificationExpiry;
        }

        const res = await authFetch('/vetter-certifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.detail || 'Failed to issue credential');
        }

        result.innerHTML = `
          <div class="success">
            <strong>Vetter Certification Issued Successfully!</strong>
            <div class="result-field">
              <strong>Credential SAID:</strong>
              <code>${data.said}</code>
            </div>
            <p>This certification can now be used as a backlink edge in TN Allocation and Legal Entity credentials.</p>
          </div>
        `;

        // Refresh the list
        loadCertifications();

      } catch (err) {
        result.innerHTML = `<div class="error"><strong>Error:</strong> ${err.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Issue Vetter Certification';
      }
    });

    // Initialize searchable selectors
    const eccSelect = new SearchableMultiSelect(
      document.getElementById('eccSearchableSelect'),
      E164_CODES,
      { type: 'ecc', commonCodes: COMMON_ECC }
    );
    const jurisdictionSelect = new SearchableMultiSelect(
      document.getElementById('jurisdictionSearchableSelect'),
      ISO_CODES,
      { type: 'jurisdiction', commonCodes: COMMON_JURISDICTION }
    );
    loadOrganizations();
    loadCertifications();
  </script>
</body>
</html>
